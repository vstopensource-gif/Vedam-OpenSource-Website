<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Activity - Vedam Open Source Club</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23667eea'/><stop offset='100%25' style='stop-color:%23764ba2'/></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23g)'/><text x='50' y='70' font-size='60' font-weight='bold' fill='white' text-anchor='middle' font-family='Arial'>V</text></svg>">
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
      // Import Firebase services from config module
      import { auth, db, realtimeDb } from './firebase-config.js';
      
      // Import additional Firebase functions
      import {
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        doc,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        ref,
        push,
        onValue,
        off,
        serverTimestamp,
        set,
        onDisconnect,
        get,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      window.auth = auth;
      window.db = db;
      window.realtimeDb = realtimeDb;
      window.getDoc = getDoc;
      window.doc = doc;
      window.setDoc = setDoc;
      window.ref = ref;
      window.push = push;
      window.onValue = onValue;
      window.off = off;
      window.serverTimestamp = serverTimestamp;
      window.set = set;
      window.onDisconnect = onDisconnect;
      window.get = get;
      
      window.logout = function() {
        signOut(auth).then(() => {
          window.location.href = 'index.html';
        }).catch((error) => {
          console.error('Error signing out:', error);
          window.location.href = 'index.html';
        });
      };
      
      window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('open');
      };
      
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            const memberDoc = await getDoc(doc(db, "Members", user.uid));
            if (memberDoc.exists()) {
              const memberData = memberDoc.data();
              
              window.currentUserData = {
                uid: user.uid,
                displayName: memberData.name || memberData.displayName || user.displayName || "User",
                email: memberData.email || user.email || "",
                photoURL: memberData.photoURL || user.photoURL || null,
              };
              
              const userNameEl = document.getElementById('userNameSidebar');
              const userEmailEl = document.getElementById('userEmailSidebar');
              const userAvatarEl = document.getElementById('userAvatarSidebar');
              
              if (userNameEl) userNameEl.textContent = window.currentUserData.displayName;
              if (userEmailEl) userEmailEl.textContent = window.currentUserData.email;
              
              if (userAvatarEl) {
                if (window.currentUserData.photoURL) {
                  userAvatarEl.innerHTML = `<img src="${window.currentUserData.photoURL}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                  userAvatarEl.style.display = 'block';
                  userAvatarEl.style.width = '40px';
                  userAvatarEl.style.height = '40px';
                  userAvatarEl.style.borderRadius = '50%';
                  userAvatarEl.style.overflow = 'hidden';
                } else {
                  // Generate initials from name
                  const name = window.currentUserData.displayName || 'User';
                  const words = name.trim().split(/\s+/);
                  let initials = '';
                  if (words.length >= 2) {
                    initials = (words[0][0] + words[words.length - 1][0]).toUpperCase();
                  } else {
                    initials = name.substring(0, 2).toUpperCase();
                  }
                  userAvatarEl.innerHTML = initials;
                  userAvatarEl.style.fontSize = initials.length > 1 ? '0.85rem' : '1rem';
                }
              }
              
              loadGitHubActivity(user.uid);
            }
          } catch (error) {
            console.error('Error loading user data:', error);
          }
        } else {
          window.location.href = 'login.html';
        }
      });
      // Highlight correct sidebar item based on current page
      (function(){
        try {
          const path = window.location.pathname.split('/').pop() || 'github.html';
          const navLinks = document.querySelectorAll('.sidebar-nav .nav-item');
          navLinks.forEach((a) => a.classList.remove('active'));
          const match = Array.from(navLinks).find(a => (a.getAttribute('href') || '').endsWith(path));
          if (match) match.classList.add('active');
        } catch(e) {}
      })();
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: #f8fafc;
        overflow-x: hidden;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar Navigation */
      .sidebar {
        width: 320px;
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        color: white;
        position: fixed;
        height: 100vh;
        left: 0;
        top: 0;
        z-index: 1000;
        transition: all 0.3s ease;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
      }

      .sidebar-header {
        padding: 2rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-logo {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        font-size: 1.5rem;
        font-weight: 700;
        text-decoration: none;
        color: inherit;
      }

      .sidebar-logo i {
        font-size: 2rem;
      }

      .sidebar-logo:hover,
      .sidebar-logo:focus,
      .sidebar-logo:visited {
        text-decoration: none;
        color: inherit;
      }

      .sidebar-nav {
        padding: 1rem 0;
      }

      .nav-item {
        display: block;
        padding: 1rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
        position: relative;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-left-color: rgba(255, 255, 255, 0.3);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border-left-color: #ffd700;
      }

      .nav-item i {
        width: 20px;
        margin-right: 0.8rem;
        text-align: center;
      }

      .nav-item span {
        font-weight: 500;
      }

      .sidebar-footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .user-profile-sidebar {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        min-width: 0; /* Allow flex children to shrink */
      }

      .user-avatar-sidebar {
        width: 40px;
        height: 40px;
        min-width: 40px; /* Prevent shrinking */
        flex-shrink: 0; /* Prevent the circle from changing shape */
        border-radius: 50%;
        background: #667eea;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        overflow: hidden;
        font-size: 0.85rem; /* Base font size for initials */
        line-height: 1;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .user-info-sidebar {
        flex: 1; /* Take remaining space */
        min-width: 0; /* Critical for text truncation in flex */
        overflow: hidden;
      }

      .user-info-sidebar h4 {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      .user-info-sidebar p {
        font-size: 0.8rem;
        opacity: 0.8;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .logout-btn-sidebar {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 0.8rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        cursor: pointer;
      }

      .logout-btn-sidebar:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
      }

      /* Main Content Area */
      .main-content {
        flex: 1;
        margin-left: 320px;
        min-height: 100vh;
        transition: all 0.3s ease;
      }

      .main-header {
        background: white;
        padding: 1.5rem 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .main-header h1 {
        font-size: 1.8rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
      }

      .main-header p {
        color: #666;
        font-size: 1rem;
      }

      .header-left {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .refresh-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.6rem 1rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 6px 18px rgba(102, 126, 234, 0.25);
      }

      .refresh-btn:hover { transform: translateY(-1px); }
      .refresh-btn:disabled { opacity: 0.65; cursor: not-allowed; transform: none; box-shadow: none; }

      .content-area {
        padding: 2rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
      }

      /* Metrics grid (large gradient cards like screenshot 2) */
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }
      .metric-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 18px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        min-height: 140px;
        text-align: center;
      }
      .metric-number {
        font-size: 2.4rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
      }
      .metric-label {
        font-size: 1.05rem;
        opacity: 0.95;
        font-weight: 600;
      }

      /* Two-up grid for 50/50 charts */
      .half-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }
      @media (max-width: 992px) {
        .half-grid { grid-template-columns: 1fr; }
      }

      /* Contribution heatmap (CSS grid like GitHub) - Enhanced */
      .heatmap-grid {
        display: grid;
        grid-auto-flow: column;
        grid-template-rows: repeat(7, 14px);
        grid-auto-columns: 14px;
        gap: 4px;
        padding: 2rem;
        background: linear-gradient(135deg, #f8fafc, #ffffff);
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        overflow: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        max-width: 100%;
      }
      
      .heatmap-cell {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        background: #ebedf0;
        transition: all 0.3s ease;
        cursor: pointer;
        border: 1px solid transparent;
      }
      
      .heatmap-cell:hover {
        transform: scale(1.3);
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        z-index: 10;
      }
      
      .heatmap-legend {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
        font-size: 0.85rem;
        color: #6b7280;
      }
      
      .heatmap-legend-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }
      
      .heatmap-legend-box {
        width: 12px;
        height: 12px;
        border-radius: 2px;
      }

      /* Tabs Section */
      .details-section {
        margin-top: 2rem;
      }
      
      .tabs-container {
        display: flex;
        gap: 1rem;
        border-bottom: 2px solid #e2e8f0;
        margin-bottom: 2rem;
      }
      
      .tab-btn {
        background: none;
        border: none;
        padding: 1rem 2rem;
        cursor: pointer;
        font-weight: 600;
        color: #666;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        font-size: 1rem;
      }
      
      .tab-btn:hover {
        color: #667eea;
      }
      
      .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }
      
      .tab-content {
        display: none;
      }
      
      .tab-content.active {
        display: block;
      }
      
      .pr-item, .commit-item, .repo-item {
        background: white;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
      }
      
      .pr-item:hover, .commit-item:hover, .repo-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      
      .pr-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0.75rem;
      }
      
      .pr-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
      }
      
      .pr-title a {
        color: #333;
        text-decoration: none;
      }
      
      .pr-title a:hover {
        color: #667eea;
      }
      
      .pr-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        font-size: 0.9rem;
        color: #666;
      }
      
      .pr-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }
      
      .pr-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
      }
      
      .pr-badge.open {
        background: #d1fae5;
        color: #065f46;
      }
      
      .pr-badge.merged {
        background: #ddd6fe;
        color: #5b21b6;
      }
      
      .pr-badge.closed {
        background: #fee2e2;
        color: #991b1b;
      }
      
      .pr-body {
        color: #666;
        line-height: 1.6;
        margin-top: 0.5rem;
        font-size: 0.95rem;
      }
      
      .repo-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
      }
      
      .repo-name a {
        color: #667eea;
        text-decoration: none;
      }
      
      .repo-name a:hover {
        text-decoration: underline;
      }
      
      .repo-stats {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.75rem;
        font-size: 0.9rem;
        color: #666;
      }
      
      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
        font-size: 1.1rem;
      }
      
      .empty-state i {
        font-size: 3rem;
        color: #ccc;
        margin-bottom: 1rem;
      }

      /* PR Status Table */
      .pr-status-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      
      .pr-status-table th {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
      }
      
      .pr-status-table td {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.95rem;
      }
      
      .pr-status-table tbody tr:hover {
        background: #f9fafb;
        transition: background 0.2s ease;
      }
      
      .pr-status-table tbody tr:last-child td {
        border-bottom: none;
      }
      
      .pr-status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
      }
      
      .pr-status-indicator i {
        font-size: 0.7rem;
      }
      
      .pr-progress-bar {
        flex: 1;
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
      }
      
      .pr-progress-fill {
        height: 100%;
        transition: width 0.6s ease;
      }

      .dashboard-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        border: 1px solid #e2e8f0;
      }

      .dashboard-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 15px 15px 0 0;
      }

      .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .card-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.3rem;
        flex-shrink: 0;
      }

      .card-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin: 0;
        flex: 1;
      }

      .card-content {
        color: #666;
        line-height: 1.6;
        margin-bottom: 1.5rem;
      }

      .card-actions {
        display: flex;
        gap: 1rem;
      }

      .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .activity-stat {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .activity-stat:hover {
        transform: translateY(-5px);
      }

      .activity-stat .stat-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: white;
      }

      .activity-stat .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        color: white;
      }

      .chart-container {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
      }

      .chart-container canvas {
        max-height: 400px;
      }

      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .mobile-menu-btn {
          display: block;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .content-area {
          padding: 1rem;
        }

        .main-header {
          padding: 1rem;
        }

        .main-header h1 {
          font-size: 1.5rem;
        }
      }

      .mobile-menu-btn {
        display: none;
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 1001;
        background: #667eea;
        color: white;
        border: none;
        padding: 0.8rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
      }

      @media (max-width: 768px) {
        .mobile-menu-btn {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Mobile Menu Button -->
      <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>

      <!-- Sidebar Navigation -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <a href="dashboard.html" class="sidebar-logo">
            <i class="fas fa-code"></i>
            <span>Vedam Club</span>
          </a>
        </div>

        <nav class="sidebar-nav">
          <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Overview</span>
          </a>
          <a href="github.html" class="nav-item">
            <i class="fab fa-github"></i>
            <span>GitHub Activity</span>
          </a>
          <a href="projects.html" class="nav-item">
            <i class="fas fa-project-diagram"></i>
            <span>Projects</span>
          </a>
          <a href="community.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Community</span>
          </a>
          <a href="events.html" class="nav-item">
            <i class="fas fa-calendar-alt"></i>
            <span>Events</span>
          </a>
          <a href="resources.html" class="nav-item">
            <i class="fas fa-book"></i>
            <span>Resources</span>
          </a>
          <a href="achievements.html" class="nav-item">
            <i class="fas fa-trophy"></i>
            <span>Achievements</span>
          </a>
          <a href="settings.html" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </a>
        </nav>

        <div class="sidebar-footer">
          <div class="user-profile-sidebar">
            <div class="user-avatar-sidebar" id="userAvatarSidebar">
              <i class="fas fa-user"></i>
            </div>
            <div class="user-info-sidebar">
              <h4 id="userNameSidebar">User Name</h4>
              <p id="userEmailSidebar">user@vedamsot.org</p>
            </div>
          </div>
          <a href="#" class="logout-btn-sidebar" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </a>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="main-content">
        <div class="main-header">
          <div class="header-left">
            <h1 id="mainTitle">GitHub Activity</h1>
            <p id="mainSubtitle">Track your coding contributions and repository activity</p>
          </div>
          <button id="refreshBtn" class="refresh-btn" onclick="refreshFromGitHub()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>

        <div class="content-area">
          <!-- Overview Cards (Primary Metrics) -->
          <div class="metrics-grid" id="overviewCards"></div>

          <!-- Activity Summary (100%) -->
          <div class="chart-container">
            <h3>Activity Summary</h3>
            <canvas id="activityChart"></canvas>
          </div>

          <!-- Language Distribution (100%) -->
          <div class="chart-container">
            <h3>Language Distribution</h3>
            <canvas id="languageChart"></canvas>
          </div>

          <!-- PR Status (100%) -->
          <div class="chart-container">
            <h3>Pull Request Status</h3>
            <canvas id="prStatusChart"></canvas>
          </div>

          <!-- PRs Trend Graph (100%) -->
          <div class="chart-container">
            <h3>
              <i class="fas fa-chart-line"></i> Pull Requests Activity (Last 30 Days)
            </h3>
            <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem; margin-bottom: 1rem;">
              Daily breakdown of PR activity by status
            </p>
            <canvas id="recentPrsTimeline"></canvas>
          </div>

          <!-- PR Status Breakdown Table -->
          <div class="chart-container">
            <h3>Pull Request Status Breakdown</h3>
            <table class="pr-status-table">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Count</th>
                  <th>Percentage</th>
                </tr>
              </thead>
              <tbody id="prStatusTableBody">
                <tr>
                  <td colspan="3" style="text-align: center;">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Contribution Heatmap (centered) -->
          <div class="chart-container" id="heatmapContainer" style="display:none;">
            <h3 style="margin-bottom: 1.5rem;">
              <i class="fas fa-calendar-alt"></i> Contribution Calendar (Last 12 Months)
            </h3>
            <div id="heatmapPlaceholder" class="heatmap-grid" style="margin: 0 auto;"></div>
            <div class="heatmap-legend">
              <span style="margin-right: 0.5rem;">Less</span>
              <div class="heatmap-legend-item">
                <div class="heatmap-legend-box" style="background: #ebedf0;"></div>
              </div>
              <div class="heatmap-legend-item">
                <div class="heatmap-legend-box" style="background: #c6e48b;"></div>
              </div>
              <div class="heatmap-legend-item">
                <div class="heatmap-legend-box" style="background: #7bc96f;"></div>
              </div>
              <div class="heatmap-legend-item">
                <div class="heatmap-legend-box" style="background: #239a3b;"></div>
              </div>
              <div class="heatmap-legend-item">
                <div class="heatmap-legend-box" style="background: #196127;"></div>
              </div>
              <span style="margin-left: 0.5rem;">More</span>
            </div>
          </div>

          <!-- Tabbed Details Section -->
          <div class="details-section">
            <div class="tabs-container">
              <button class="tab-btn active" data-tab="prs">
                <i class="fas fa-code-branch"></i> Pull Requests
              </button>
              <button class="tab-btn" data-tab="repos">
                <i class="fas fa-folder"></i> Repositories
              </button>
            </div>
            
            <div class="tab-content active" id="prs-tab">
              <div class="pr-list" id="prList">
                <div class="empty-state">
                  <i class="fas fa-spinner fa-spin"></i>
                  <p>Loading pull requests...</p>
                </div>
              </div>
            </div>
            
            <div class="tab-content" id="repos-tab">
              <div class="repos-list" id="reposList">
                <div class="empty-state">
                  <i class="fas fa-spinner fa-spin"></i>
                  <p>Loading repositories...</p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script>
      let activityChart = null;
      let languageChart = null;
      let prStatusChart = null;
      let recentPrsChart = null;

      async function loadGitHubActivity(uid) {
        try {
          const cacheKey = `githubActivityCache:${uid}`;
          const cached = localStorage.getItem(cacheKey);
          const reposCacheKey = `githubReposCache:${uid}`;
          const cachedRepos = localStorage.getItem(reposCacheKey);
          
          if (cached) {
            const activity = JSON.parse(cached);
            displayActivity(activity);
            createCharts(activity);
            
            // Load cached repos if available
            if (cachedRepos) {
              window.cachedRepos = JSON.parse(cachedRepos);
              displayReposTab(window.cachedRepos);
            }
            return;
          }
          // No cache: prompt user to refresh to fetch data
          const overview = document.getElementById('overviewCards');
          if (overview) {
            overview.innerHTML = '<div class="metric-card"><div class="metric-number">â€”</div><div class="metric-label">Click Refresh to load data</div></div>';
          }
        } catch (error) {
          console.error('Error loading cached activity:', error);
        }
      }

      function displayActivity(activity) {
        // Debug: Log activity data to verify commits are present
        console.log('Displaying activity data:', {
          commits: activity.commits,
          contributions: activity.contributions,
          pullRequests: activity.pullRequests,
          totalStars: activity.totalStars
        });
        
        // Overview Cards per Data_Visualization_Strategy.md
        const overview = document.getElementById('overviewCards');
        const totalRepos = (activity.publicRepos || 0) + (activity.privateRepos || 0) || (activity.reposContributed || 0);
        const commitsValue = activity.commits || 0;
        console.log('Commits value for display:', commitsValue);
        
        const primaryCards = [
          { label: 'Total Repositories', value: totalRepos, icon: 'fas fa-folder' },
          { label: 'Total Stars', value: activity.totalStars || 0, icon: 'fas fa-star' },
          { label: 'Total Contributions', value: activity.contributions || 0, icon: 'fas fa-chart-line' },
          { label: 'Total Pull Requests', value: activity.pullRequests || 0, icon: 'fas fa-code-branch' },
        ];
        const secondaryCards = [
          { label: 'Total Commits', value: commitsValue, icon: 'fas fa-laptop-code' },
          { label: 'Total Forks', value: activity.totalForks || 0, icon: 'fas fa-code-branch' },
          { label: 'Total Issues', value: activity.issues || 0, icon: 'fas fa-bug' },
          { label: 'Followers', value: activity.followers || 0, icon: 'fas fa-user-friends' },
        ];
        const renderCard = (c) => `
          <div class="metric-card">
            <div class="metric-number">${c.value}</div>
            <div class="metric-label"><i class="${c.icon}"></i> ${c.label}</div>
          </div>`;
        overview.innerHTML = [...primaryCards, ...secondaryCards].map(renderCard).join('');

        // Heatmap placeholder visibility
        const heatmap = document.getElementById('heatmapContainer');
        if (activity.contributionCalendar && activity.contributionCalendar.weeks) {
          heatmap.style.display = 'block';
          renderHeatmap(activity.contributionCalendar);
        } else {
          heatmap.style.display = 'none';
        }

        // Populate tabs with data
        if (activity.recentPRs) {
          displayPRsTab(activity.recentPRs);
        }
        
        // Get repos from cache or activity data
        if (window.cachedRepos) {
          displayReposTab(window.cachedRepos);
        }
        
        // Populate PR status table
        displayPRStatusTable(activity);
      }

      function createCharts(activity) {
        const ctx = document.getElementById('activityChart');
        const langCtx = document.getElementById('languageChart');
        const prStatusCtx = document.getElementById('prStatusChart');
        const recentPrsCtx = document.getElementById('recentPrsTimeline');
        
        if (activityChart) activityChart.destroy();
        if (languageChart) languageChart.destroy();
        if (prStatusChart) prStatusChart.destroy();
        if (recentPrsChart) recentPrsChart.destroy();

        activityChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Repos', 'Commits', 'Pull Requests', 'Stars', 'Issues', 'Forks'],
            datasets: [{
              label: 'Activity',
              data: [
                (activity.publicRepos || 0) + (activity.privateRepos || 0) || (activity.reposContributed || 0),
                activity.commits || 0,
                activity.pullRequests || 0,
                activity.totalStars || 0,
                activity.issues || 0,
                activity.totalForks || 0
              ],
              backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(102, 126, 234, 0.6)',
                'rgba(118, 75, 162, 0.6)',
                'rgba(250, 204, 21, 0.7)',
                'rgba(99, 102, 241, 0.7)'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });

        if (activity.languages) {
          let langLabels = [];
          let langValues = [];
          if (Array.isArray(activity.languages)) {
            langLabels = activity.languages.map(l => l.language);
            langValues = activity.languages.map(l => l.count);
          } else if (typeof activity.languages === 'object') {
            langLabels = Object.keys(activity.languages);
            langValues = Object.values(activity.languages);
          }
          if (!langLabels.length) {
            // nothing to render
          } else {
          
          languageChart = new Chart(langCtx, {
            type: 'pie',
            data: {
              labels: langLabels,
              datasets: [{
                data: langValues,
                backgroundColor: [
                  'rgba(102, 126, 234, 0.8)',
                  'rgba(118, 75, 162, 0.8)',
                  'rgba(240, 147, 251, 0.8)',
                  'rgba(102, 126, 234, 0.6)',
                  'rgba(118, 75, 162, 0.6)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context){
                      const dataset = context.dataset;
                      const total = dataset.data.reduce((a,b)=>a + (Number(b)||0), 0);
                      const val = Number(context.raw) || 0;
                      const pct = total ? ((val/total)*100).toFixed(1) : 0;
                      return `${context.label}: ${pct}%`;
                    }
                  }
                }
              }
            }
          });
          }
        }

        // PR Status Breakdown (with fallbacks for cached data)
        if (prStatusCtx) {
          let open = (activity.openPRs ?? 0);
          let merged = (activity.mergedPRs ?? 0);
          let closed = (activity.closedPRs ?? 0);
          if ((open + merged + closed) === 0 && (activity.pullRequests || 0) > 0) {
            // Older cached objects may not have per-status counts; show all as open
            open = activity.pullRequests || 0;
          }
          prStatusChart = new Chart(prStatusCtx, {
            type: 'pie',
            data: {
              labels: ['Open', 'Merged', 'Closed'],
              datasets: [{
                data: [open, merged, closed],
                backgroundColor: ['rgba(234,179,8,0.9)', 'rgba(16,185,129,0.9)', 'rgba(148,163,184,0.9)']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context){
                      const val = Number(context.raw) || 0;
                      return `${context.label}: ${val.toLocaleString()}`;
                    }
                  }
                }
              }
            }
          });
        }

        // PRs Trend (daily for last 30 days) - Enhanced visualization
        if (recentPrsCtx && Array.isArray(activity.recentPRs) && activity.recentPRs.length) {
          const prWrapper = recentPrsCtx.closest('.chart-container');
          if (prWrapper) { prWrapper.style.display = 'block'; }
          
          // Get last 30 days of data
          const today = new Date();
          const thirtyDaysAgo = new Date(today);
          thirtyDaysAgo.setDate(today.getDate() - 30);
          
          // Create array of last 30 days
          const dailyData = {};
          for (let i = 0; i < 30; i++) {
            const date = new Date(thirtyDaysAgo);
            date.setDate(thirtyDaysAgo.getDate() + i);
            const dateKey = date.toISOString().slice(0, 10);
            dailyData[dateKey] = { open: 0, merged: 0, closed: 0, total: 0 };
          }
          
          // Aggregate PRs by day and status
          activity.recentPRs.forEach(pr => {
            if (!pr.created_at) return;
            const dateKey = pr.created_at.slice(0, 10);
            if (dailyData[dateKey]) {
              dailyData[dateKey].total += 1;
              if (pr.merged) {
                dailyData[dateKey].merged += 1;
              } else if (pr.state === 'open') {
                dailyData[dateKey].open += 1;
              } else if (pr.state === 'closed') {
                dailyData[dateKey].closed += 1;
              }
            }
          });
          
          // Prepare chart data
          const sortedDates = Object.keys(dailyData).sort();
          const labels = sortedDates.map(date => {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          });
          const totalValues = sortedDates.map(date => dailyData[date].total);
          const openValues = sortedDates.map(date => dailyData[date].open);
          const mergedValues = sortedDates.map(date => dailyData[date].merged);
          const closedValues = sortedDates.map(date => dailyData[date].closed);
          
          recentPrsChart = new Chart(recentPrsCtx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                {
                  label: 'Merged PRs',
                  data: mergedValues,
                  backgroundColor: 'rgba(139, 92, 246, 0.8)',
                  borderColor: 'rgba(139, 92, 246, 1)',
                  borderWidth: 2,
                  borderRadius: 6,
                },
                {
                  label: 'Open PRs',
                  data: openValues,
                  backgroundColor: 'rgba(16, 185, 129, 0.8)',
                  borderColor: 'rgba(16, 185, 129, 1)',
                  borderWidth: 2,
                  borderRadius: 6,
                },
                {
                  label: 'Closed PRs',
                  data: closedValues,
                  backgroundColor: 'rgba(239, 68, 68, 0.8)',
                  borderColor: 'rgba(239, 68, 68, 1)',
                  borderWidth: 2,
                  borderRadius: 6,
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              scales: {
                x: {
                  stacked: true,
                  grid: {
                    display: false
                  },
                  ticks: {
                    font: {
                      size: 11
                    },
                    maxRotation: 45,
                    minRotation: 45
                  }
                },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                  }
                }
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: {
                      size: 13,
                      weight: 600
                    }
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 12,
                  titleFont: {
                    size: 14,
                    weight: 'bold'
                  },
                  bodyFont: {
                    size: 13
                  },
                  borderColor: 'rgba(102, 126, 234, 0.5)',
                  borderWidth: 1,
                  callbacks: {
                    label: function(context) {
                      return `${context.dataset.label}: ${context.parsed.y}`;
                    },
                    afterBody: function(tooltipItems) {
                      const total = tooltipItems.reduce((sum, item) => sum + item.parsed.y, 0);
                      return `Total: ${total} PR${total !== 1 ? 's' : ''}`;
                    }
                  }
                }
              }
            }
          });
        } else if (recentPrsCtx) {
          // Hide empty chart area if no trend data yet
          const wrapper = recentPrsCtx.closest('.chart-container');
          if (wrapper) { wrapper.style.display = 'none'; }
        }
      }

      // Refresh flow: fetch from GitHub, store in Firebase, cache locally, then render
      async function refreshFromGitHub() {
        try {
          const user = window.auth && window.auth.currentUser;
          if (!user || !user.uid) return alert('Please login again.');
          const btn = document.getElementById('refreshBtn');
          if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing'; }

          // Read token from Members doc
          const memberSnap = await window.getDoc(window.doc(window.db, 'Members', user.uid));
          if (!memberSnap.exists()) throw new Error('Member not found');
          const member = memberSnap.data();
          const token = member.githubAccessToken;
          if (!token) throw new Error('GitHub not connected');

          const activity = await fetchGithubActivityData(token);
          
          // Fetch full repos list for the repos tab
          const headers = { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' };
          let allRepos = [];
          let page = 1;
          let hasMore = true;
          
          while (hasMore && page <= 10) { // Limit to 10 pages (1000 repos) for performance
            const reposRes = await fetch(`https://api.github.com/user/repos?per_page=100&page=${page}&sort=updated`, { headers });
            if (reposRes.ok) {
              const pageRepos = await reposRes.json();
              allRepos = allRepos.concat(pageRepos);
              hasMore = pageRepos.length === 100;
              page++;
            } else {
              break;
            }
          }
          
          // Store repos in global cache for tabs
          window.cachedRepos = allRepos;
          
          // Save to Firebase (structure kept same as existing usage)
          await window.setDoc(window.doc(window.db, 'Members', user.uid), {
            githubActivity: activity,
            lastActivityUpdate: new Date().toISOString(),
          }, { merge: true });

          // Cache locally and render
          const cacheKey = `githubActivityCache:${user.uid}`;
          localStorage.setItem(cacheKey, JSON.stringify(activity));
          const reposCacheKey = `githubReposCache:${user.uid}`;
          localStorage.setItem(reposCacheKey, JSON.stringify(allRepos));
          
          displayActivity(activity);
          createCharts(activity);
          
          // Populate tabs
          if (activity.recentPRs) {
            displayPRsTab(activity.recentPRs);
          }
          if (allRepos.length > 0) {
            displayReposTab(allRepos);
          }
          
          // Populate PR status table
          displayPRStatusTable(activity);

          if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh'; }
        } catch (e) {
          console.error(e);
          alert(e && e.message ? e.message : 'Failed to refresh');
          const btn = document.getElementById('refreshBtn');
          if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh'; }
        }
      }

      async function fetchGithubActivityData(accessToken) {
        const headers = { Authorization: `token ${accessToken}`, Accept: 'application/vnd.github.v3+json' };
        
        // Fetch user info (followers, following, etc.)
        const userRes = await fetch('https://api.github.com/user', { headers });
        if (!userRes.ok) throw new Error('GitHub auth failed');
        const user = await userRes.json();
        const username = user.login;

        // Fetch ALL repositories with pagination
        let repositories = [];
        let page = 1;
        let hasMore = true;
        
        while (hasMore) {
          const reposRes = await fetch(`https://api.github.com/user/repos?per_page=100&page=${page}&sort=updated`, { headers });
        if (!reposRes.ok) throw new Error('Failed to load repositories');
          const pageRepos = await reposRes.json();
          repositories = repositories.concat(pageRepos);
          hasMore = pageRepos.length === 100;
          page++;
        }

        // Use Search API for complete PR counts and data
        let openPRs = 0, closedPRs = 0, mergedPRs = 0, totalIssues = 0;
        let recentPRs = [];
        
        try {
          const [openPRsRes, mergedPRsRes, closedPRsRes, issuesRes] = await Promise.all([
            fetch(`https://api.github.com/search/issues?q=author:${username}+type:pr+is:open&per_page=1`, { headers }),
            fetch(`https://api.github.com/search/issues?q=author:${username}+type:pr+is:merged&per_page=1`, { headers }),
            fetch(`https://api.github.com/search/issues?q=author:${username}+type:pr+is:closed+-is:merged&per_page=1`, { headers }),
            fetch(`https://api.github.com/search/issues?q=author:${username}+type:issue&per_page=1`, { headers })
          ]);
          
          if (openPRsRes.ok) {
            const data = await openPRsRes.json();
            openPRs = data.total_count || 0;
          }
          if (mergedPRsRes.ok) {
            const data = await mergedPRsRes.json();
            mergedPRs = data.total_count || 0;
          }
          if (closedPRsRes.ok) {
            const data = await closedPRsRes.json();
            closedPRs = data.total_count || 0;
          }
          if (issuesRes.ok) {
            const data = await issuesRes.json();
            totalIssues = data.total_count || 0;
          }
          
          // Fetch detailed PR list (up to 100 most recent)
          const prSearchRes = await fetch(`https://api.github.com/search/issues?q=author:${username}+type:pr&sort=created&order=desc&per_page=100`, { headers });
          if (prSearchRes.ok) {
            const prData = await prSearchRes.json();
            recentPRs = prData.items.map(pr => ({
              title: pr.title,
              number: pr.number,
              repo: pr.repository_url ? pr.repository_url.split('/').slice(-2).join('/') : 'Unknown',
              state: pr.state,
              created_at: pr.created_at,
              updated_at: pr.updated_at,
              url: pr.html_url,
              body: pr.body || '',
              comments: pr.comments || 0,
              merged: pr.pull_request && pr.pull_request.merged_at ? true : false,
              merged_at: pr.pull_request && pr.pull_request.merged_at ? pr.pull_request.merged_at : null
            }));
          }
        } catch (searchError) {
          console.error('Search API error:', searchError);
        }
        
        // Fetch lifetime contributions using GraphQL API
        let commits = 0;
        let contributions = 0;
        let contributionCalendar = null;
        let events = []; // Declare events at top level for use later
        
        try {
          // Use GraphQL for accurate lifetime contributions
          const graphqlQuery = {
            query: `
              query($username: String!) {
                user(login: $username) {
                  contributionsCollection {
                    contributionCalendar {
                      totalContributions
                      weeks {
                        contributionDays {
                          contributionCount
                          date
                        }
                      }
                    }
                  }
                }
              }
            `,
            variables: { username: username }
          };
          
          const graphqlResponse = await fetch('https://api.github.com/graphql', {
            method: 'POST',
            headers: {
              'Authorization': `bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(graphqlQuery)
          });
          
          if (graphqlResponse.ok) {
            const graphqlData = await graphqlResponse.json();
            if (graphqlData.data && graphqlData.data.user) {
              contributionCalendar = graphqlData.data.user.contributionsCollection.contributionCalendar;
              contributions = contributionCalendar.totalContributions || 0;
              console.log(`Total contributions (lifetime via GraphQL): ${contributions}`);
            }
          } else {
            console.warn('GraphQL API failed:', graphqlResponse.status);
          }
        } catch (graphqlError) {
          console.error('GraphQL API error:', graphqlError);
        }
        
        // Fetch commits using Search API
        try {
          const commitsSearchRes = await fetch(`https://api.github.com/search/commits?q=author:${username}&per_page=1`, { 
            headers: {
              ...headers,
              'Accept': 'application/vnd.github.cloak-preview+json'
            }
          });
          
          if (commitsSearchRes.ok) {
            const commitsData = await commitsSearchRes.json();
            commits = commitsData.total_count || 0;
            console.log(`Total commits (lifetime): ${commits}`);
          } else {
            console.warn('Commits search failed:', commitsSearchRes.status);
          }
        } catch (commitsError) {
          console.error('Commits API error:', commitsError);
        }
        
        // Fetch events for issues count and fallback data
        try {
          const eventsRes = await fetch(`https://api.github.com/users/${username}/events?per_page=100`, { headers });
          if (eventsRes.ok) {
            events = await eventsRes.json();
            console.log(`Events fetched: ${events.length}`);
            
            // Fallback if GraphQL or Search failed
            if (contributions === 0) contributions = events.length;
            if (commits === 0) {
              commits = events.filter(event => event.type === 'PushEvent').reduce((total, event) => {
                return total + (event.payload && event.payload.commits ? event.payload.commits.length : 0);
              }, 0);
            }
          }
        } catch (eventsError) {
          console.error('Events API error:', eventsError);
        }

        // Aggregate
        const totalStars = repositories.reduce((s, r) => s + (r.stargazers_count || 0), 0);
        const totalForks = repositories.reduce((s, r) => s + (r.forks_count || 0), 0);

        // Aggregate languages by bytes using per-repo languages endpoint
        const languagesMap = {};
        const languagesPromises = repositories.slice(0, 100).map(async (repo) => {
          try {
            const res = await fetch(repo.languages_url, { headers });
            if (!res.ok) return;
            const obj = await res.json();
            Object.entries(obj).forEach(([lang, bytes]) => {
              if (!lang) return;
              languagesMap[lang] = (languagesMap[lang] || 0) + (bytes || 0);
            });
          } catch(_) {}
        });
        await Promise.all(languagesPromises);

        // Build activity data matching exact Firebase schema
        const activityData = {
          // Counts
          commits: commits,
          contributions: contributions,
          followers: user.followers || 0,
          following: user.following || 0,
          issues: events && events.length > 0 ? events.filter(e => e.type === 'IssuesEvent').length : 0,
          totalIssues: totalIssues,
          openPRs: openPRs,
          closedPRs: closedPRs,
          mergedPRs: mergedPRs,
          pullRequests: openPRs + closedPRs + mergedPRs,
          publicRepos: repositories.filter(r => !r.private).length,
          privateRepos: repositories.filter(r => r.private).length,
          totalStars: totalStars,
          totalForks: totalForks,
          
          // Languages as map { languageName: bytes }
          languages: languagesMap,
          
          // Recent PRs array with full details
          recentPRs: recentPRs,
          
          // Contribution calendar from GraphQL
          contributionCalendar: contributionCalendar,
          
          // Metadata
          lastUpdated: new Date().toISOString(),
          
          // Legacy fields for backwards compatibility
          reposContributed: repositories.length,
          topRepos: repositories.sort((a,b)=>b.stargazers_count-a.stargazers_count).slice(0,5).map(r=>({ name:r.name, stars:r.stargazers_count, forks:r.forks_count, language:r.language, url:r.html_url })),
        };
        
        console.log('Activity data prepared:', {
          commits: activityData.commits,
          contributions: activityData.contributions,
          pullRequests: activityData.pullRequests,
          totalStars: activityData.totalStars
        });
        
        return activityData;
      }

      function renderHeatmap(calendar) {
        const container = document.getElementById('heatmapPlaceholder');
        if (!container) return;
        container.innerHTML = '';
        
        // Build a flat list by week columns
        const weeks = Array.isArray(calendar.weeks) ? calendar.weeks : [];
        weeks.forEach(week => {
          const days = week.contributionDays || [];
          // Ensure 7 rows (Sun..Sat); GitHub is Sun-first
          for (let i = 0; i < 7; i++) {
            const day = days[i] || {};
            const count = day.contributionCount || 0;
            
            // Enhanced color scale with more vibrant greens
            let color = '#ebedf0';
            if (count > 0) color = '#c6e48b';
            if (count > 3) color = '#7bc96f';
            if (count > 7) color = '#239a3b';
            if (count > 12) color = '#196127';
            
            const cell = document.createElement('div');
            cell.className = 'heatmap-cell';
            cell.style.background = color;
            
            // Enhanced tooltip with formatted date
            const date = day.date ? new Date(day.date).toLocaleDateString('en-US', { 
              weekday: 'short', 
              month: 'short', 
              day: 'numeric', 
              year: 'numeric' 
            }) : '';
            cell.title = `${count} contribution${count !== 1 ? 's' : ''}${date ? ' on ' + date : ''}`;
            
            // Add data attribute for potential interactions
            if (day.date) {
              cell.setAttribute('data-date', day.date);
              cell.setAttribute('data-count', count);
            }
            
            container.appendChild(cell);
          }
        });
      }

      // Display PR Status Breakdown Table
      function displayPRStatusTable(activity) {
        const tbody = document.getElementById('prStatusTableBody');
        if (!tbody) return;
        
        const total = activity.pullRequests || 0;
        
        if (total === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">No pull requests found</td></tr>';
          return;
        }
        
        const rows = [
          { status: 'Open', count: activity.openPRs || 0, color: '#10b981', icon: 'fa-circle-dot' },
          { status: 'Merged', count: activity.mergedPRs || 0, color: '#8b5cf6', icon: 'fa-code-merge' },
          { status: 'Closed', count: activity.closedPRs || 0, color: '#ef4444', icon: 'fa-circle-xmark' }
        ];
        
        tbody.innerHTML = rows.map(row => {
          const percentage = total > 0 ? ((row.count / total) * 100).toFixed(1) : 0;
          return `
            <tr>
              <td>
                <span class="pr-status-indicator" style="color: ${row.color};">
                  <i class="fas ${row.icon}"></i> ${row.status}
                </span>
              </td>
              <td style="font-weight: 600; font-size: 1.1rem;">${row.count}</td>
              <td>
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div class="pr-progress-bar">
                    <div class="pr-progress-fill" style="width: ${percentage}%; background: ${row.color};"></div>
                  </div>
                  <span style="font-weight: 600; min-width: 50px;">${percentage}%</span>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        // Add total row
        tbody.innerHTML += `
          <tr style="background: #f9fafb; font-weight: 600; border-top: 2px solid #e2e8f0;">
            <td>Total</td>
            <td style="font-size: 1.2rem; color: #667eea;">${total}</td>
            <td>100%</td>
          </tr>
        `;
      }

      // Tab switching functionality
      function setupTabs() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
          });
        });
      }

      // Display Pull Requests tab
      function displayPRsTab(prs) {
        const container = document.getElementById('prList');
        if (!prs || !prs.length) {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-code-branch"></i><p>No pull requests found</p></div>';
          return;
        }
        
        container.innerHTML = prs.map(pr => {
          const badgeClass = pr.merged ? 'merged' : pr.state;
          const badgeText = pr.merged ? 'Merged' : (pr.state === 'open' ? 'Open' : 'Closed');
          const repoName = pr.repo || 'Unknown';
          const date = new Date(pr.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
          
          return `
            <div class="pr-item">
              <div class="pr-header">
                <div style="flex: 1;">
                  <h4 class="pr-title">
                    <a href="${pr.url}" target="_blank" rel="noopener noreferrer">
                      #${pr.number} ${pr.title}
                    </a>
                  </h4>
                  <div class="pr-meta">
                    <span><i class="fas fa-code-branch"></i> ${repoName}</span>
                    <span><i class="fas fa-calendar"></i> ${date}</span>
                    <span><i class="fas fa-comment"></i> ${pr.comments || 0} comments</span>
                    ${pr.merged_at ? `<span><i class="fas fa-check"></i> Merged ${new Date(pr.merged_at).toLocaleDateString()}</span>` : ''}
                  </div>
                </div>
                <span class="pr-badge ${badgeClass}">${badgeText}</span>
              </div>
              ${pr.body && pr.body.trim() ? `<p class="pr-body">${pr.body.substring(0, 250)}${pr.body.length > 250 ? '...' : ''}</p>` : ''}
            </div>
          `;
        }).join('');
      }

      // Display Repositories tab
      function displayReposTab(repos) {
        const container = document.getElementById('reposList');
        if (!repos || !repos.length) {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-folder"></i><p>No repositories found</p></div>';
          return;
        }
        
        // Sort by stars and take top repos
        const sortedRepos = [...repos].sort((a, b) => (b.stargazers_count || 0) - (a.stargazers_count || 0));
        
        container.innerHTML = sortedRepos.slice(0, 50).map(repo => {
          return `
            <div class="repo-item">
              <h4 class="repo-name">
                <a href="${repo.html_url}" target="_blank" rel="noopener noreferrer">
                  <i class="fas fa-folder"></i> ${repo.name}
                </a>
              </h4>
              ${repo.description ? `<p class="pr-body">${repo.description}</p>` : ''}
              <div class="repo-stats">
                <span><i class="fas fa-star"></i> ${repo.stargazers_count || 0} stars</span>
                <span><i class="fas fa-code-branch"></i> ${repo.forks_count || 0} forks</span>
                ${repo.language ? `<span><i class="fas fa-code"></i> ${repo.language}</span>` : ''}
                <span><i class="fas fa-${repo.private ? 'lock' : 'globe'}"></i> ${repo.private ? 'Private' : 'Public'}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Initialize tabs on page load
      document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
      });
    </script>
  </body>
</html>
