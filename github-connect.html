<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect GitHub - Vedam Open Source Club</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="script.js" defer></script>
    
    <style>
        .github-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
        }

        .github-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .github-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .github-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .github-header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .github-content {
            padding: 2rem;
        }

        .github-info {
            text-align: center;
            margin-bottom: 2rem;
        }

        .github-logo {
            width: 80px;
            height: 80px;
            background: #24292e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
        }

        .github-info h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        .github-info p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .benefits-list {
            text-align: left;
            margin-bottom: 2rem;
        }

        .benefits-list h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 0.8rem;
            color: #666;
        }

        .benefit-item i {
            color: #28a745;
            font-size: 1.1rem;
        }

        .github-connect-btn {
            width: 100%;
            padding: 1rem 2rem;
            background: #24292e;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            font-family: inherit;
            margin-bottom: 1rem;
        }

        .github-connect-btn:hover {
            background: #1a1e22;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(36, 41, 46, 0.3);
        }

        .github-connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .mandatory-notice {
            text-align: center;
            margin-top: 1rem;
            padding: 1rem;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            color: #856404;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .mandatory-notice i {
            color: #f39c12;
        }

        .back-home {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: white;
            text-decoration: none;
            font-size: 1.2rem;
            transition: color 0.3s ease;
        }

        .back-home:hover {
            color: #ffd700;
        }

        .loading {
            display: none;
        }

        .github-connect-btn.loading .btn-text {
            display: none;
        }

        .github-connect-btn.loading .loading {
            display: block;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 50%;
            transition: width 0.3s ease;
        }

        @media (max-width: 480px) {
            .github-container {
                padding: 1rem;
            }
            
            .github-card {
                margin: 1rem 0;
            }
        }
    </style>
</head>
<body>
    <div class="github-container">
        <a href="profile.html" class="back-home">
            <i class="fas fa-arrow-left"></i>
        </a>
        
        <div class="github-card">
            <div class="github-header">
                <h1>Connect Your GitHub</h1>
                <p>Link your GitHub profile to complete your setup</p>
            </div>
            
            <div class="github-content">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                
                <div id="successMessage" class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <span>GitHub connected successfully! Redirecting to dashboard...</span>
                </div>
                
                <div id="errorMessage" class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Failed to connect GitHub. Please try again.</span>
                </div>
                
                <div class="github-info">
                    <div class="github-logo">
                        <i class="fab fa-github"></i>
                    </div>
                    <h3>Why connect GitHub?</h3>
                    <p>Connecting your GitHub profile helps us understand your coding background and enables better collaboration within our open source community.</p>
                    
                    <div class="benefits-list">
                        <h4>Benefits of connecting:</h4>
                        <div class="benefit-item">
                            <i class="fas fa-check"></i>
                            <span>Showcase your projects and contributions</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-check"></i>
                            <span>Collaborate on club projects</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-check"></i>
                            <span>Track your open source journey</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-check"></i>
                            <span>Connect with other developers</span>
                        </div>
                    </div>
                </div>
                
                <button id="githubConnectBtn" class="github-connect-btn">
                    <i class="fab fa-github"></i>
                    <span class="btn-text">Connect with GitHub</span>
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </button>
                
                <div class="mandatory-notice">
                    <i class="fas fa-info-circle"></i>
                    <span>GitHub connection is required to access the dashboard</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase services from config module
        import { auth, db } from './firebase-config.js';
        
        // Import additional Firebase functions
        import { signInWithPopup, GithubAuthProvider, onAuthStateChanged, linkWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Set up GitHub Provider
        const githubProvider = new GithubAuthProvider();

        // Add GitHub scopes for full access
        githubProvider.addScope('repo');
        githubProvider.addScope('read:user');
        githubProvider.addScope('read:org');
        githubProvider.addScope('user:email');
        githubProvider.addScope('read:public_repo');

        // Make Firebase services available globally
        window.auth = auth;
        window.githubProvider = githubProvider;
        window.GithubAuthProvider = GithubAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.linkWithPopup = linkWithPopup;
        window.onAuthStateChanged = onAuthStateChanged;
        window.db = db;
        window.setDoc = setDoc;
        window.doc = doc;
        window.getDoc = getDoc;
    </script>

    <script>
        // Check if user is logged in and has profile data
        document.addEventListener('DOMContentLoaded', function() {
            
            const user = null; // localStorage removed
            const profile = null; // localStorage removed
            
            // Simplified: no guard redirects
            
            // Wait for Firebase to initialize
            
            setTimeout(initializeGitHubAuth, 1000);
        });

        function initializeGitHubAuth() {
            const githubConnectBtn = document.getElementById('githubConnectBtn');
            
            if (!window.auth || !window.githubProvider) {
                
                showError('GitHub authentication service not available. Please refresh the page.');
                return;
            }

            githubConnectBtn.addEventListener('click', async function() {
                try {
            // Show loading state
            this.classList.add('loading');
            this.disabled = true;
            
                    // Capture the original Google UID (must be logged in with Google before linking)
                    const originalAuthUser = window.auth && window.auth.currentUser;
                    const originalUID = originalAuthUser && originalAuthUser.uid;
                    if (!originalUID) {
                        showError('Not signed in with Google. Please login first.');
                        return;
                    }

                    // Link GitHub to the existing Google user so UID stays the same
                    
                    const result = await window.linkWithPopup(originalAuthUser, window.githubProvider);
                    
                    const user = result.user; // same Firebase user, same UID as Google
                    
                    
                    // Extract GitHub access token from credential
                    const credential = window.GithubAuthProvider.credentialFromResult(result);
                    const githubAccessToken = credential?.accessToken;
                    
                    // Use the captured original Google UID for Firestore writes
                    
                    // Fetch actual GitHub username using GitHub API
                    let actualGitHubUsername = user.displayName || user.email.split('@')[0]; // fallback
                    
                    try {
                    
                    const githubUserResponse = await fetch('https://api.github.com/user', {
                            headers: {
                                'Authorization': `token ${githubAccessToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (githubUserResponse.ok) {
                            const githubUserData = await githubUserResponse.json();
                            actualGitHubUsername = githubUserData.login; // This is the correct GitHub username
                            
                        } else {
                            
                            
                        }
                    } catch (error) {
                        
                        
                    }
                    
                    // Get GitHub profile information
                    const githubProfile = {
                        githubConnected: true,
                        githubUsername: actualGitHubUsername,
                        githubEmail: user.email,
                        githubPhotoURL: user.photoURL,
                        githubConnectedAt: new Date().toISOString(),
                        githubUID: user.uid,
                        githubAccessToken: githubAccessToken
                    };
                    
                    // Update local profile
                    const updatedProfile = { ...githubProfile };
                    
                    // Merge GitHub data into the SAME Members document using ORIGINAL Google UID
                    try {
                        
                        await saveToFirestore(updatedProfile, originalUID);
                        
                    } catch (firestoreError) {
                        
                        showError('Error saving profile. Please try again.');
                        return;
                    }
                    
                    // Fetch and save GitHub activity data using ORIGINAL user's UID
                    try {
                        
                        await fetchAndSaveGitHubActivity(originalUID, githubAccessToken);
                        
                    } catch (activityError) {
                        
                        // Continue even if activity fetch fails
                    }
            
            // Show success message
            showSuccess('GitHub connected successfully! Redirecting to dashboard...');
            
            // Redirect immediately to dashboard after connect
            window.location.href = 'dashboard.html';
                    
                } catch (error) {
                    
                    
                    let errorMessage = 'Failed to connect with GitHub. Please try again.';
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'GitHub sign-in was cancelled. Please try again.';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'Popup was blocked. Please allow popups and try again.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Please check your connection and try again.';
                    }
                    
                    showError(errorMessage);
                    
                    // Reset button state
                    const btn = document.getElementById('githubConnectBtn');
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            });
        }

        async function saveToFirestore(profileData, userUID = null) {
            try {
                const authUser = window.auth && window.auth.currentUser;
                const uid = userUID || (authUser && authUser.uid); // Use provided UID or fallback to auth user
                
                if (!uid) {
                    throw new Error('User not authenticated');
                }

                // Merge only GitHub-related fields and safe user identity data
                const memberData = {
                    uid: uid,
                    displayName: authUser && authUser.displayName,
                    email: authUser && authUser.email,
                    photoURL: authUser && authUser.photoURL,
                    githubConnected: profileData.githubConnected,
                    githubUsername: profileData.githubUsername,
                    githubEmail: profileData.githubEmail,
                    githubPhotoURL: profileData.githubPhotoURL,
                    githubUID: profileData.githubUID,
                    githubAccessToken: profileData.githubAccessToken,
                    lastUpdated: new Date().toISOString(),
                    githubConnectedAt: profileData.githubConnectedAt
                };

                // Remove any undefined values to satisfy Firestore validation
                Object.keys(memberData).forEach((k) => { if (memberData[k] === undefined) delete memberData[k]; });
                
                    // Save into the same Members document for the specified UID (merge)
                await window.setDoc(window.doc(window.db, 'Members', uid), memberData, { merge: true });
                
                
                // Explicitly update the githubConnected field to ensure it's set to true
                await window.setDoc(window.doc(window.db, 'Members', uid), {
                    githubConnected: true,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                
                
            } catch (error) {
                
                throw error;
            }
        }

        async function fetchAndSaveGitHubActivity(userId, accessToken) {
            try {
                
                
                if (!accessToken) {
                    throw new Error('No GitHub access token provided');
                }
                
                // Fetch user repositories
                const reposResponse = await fetch('https://api.github.com/user/repos?per_page=100&sort=updated', {
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!reposResponse.ok) {
                    throw new Error(`GitHub API error: ${reposResponse.status}`);
                }
                
                const repositories = await reposResponse.json();
                
                
                // Fetch user events (activity) - use more reliable approach
                let events = [];
                let commits = 0;
                let pullRequests = 0;
                let issues = 0;
                
                try {
                    // First, get the user's login from the GitHub API
                    const userResponse = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${accessToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        const username = userData.login;
                        
                        
                        // Try to get events using the username
                        const eventsResponse = await fetch(`https://api.github.com/users/${username}/events?per_page=100`, {
                            headers: {
                                'Authorization': `token ${accessToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (eventsResponse.ok) {
                            events = await eventsResponse.json();
                            
                            
                            // Calculate activity metrics from events
                            commits = events.filter(event => event.type === 'PushEvent').length;
                            pullRequests = events.filter(event => event.type === 'PullRequestEvent').length;
                            issues = events.filter(event => event.type === 'IssuesEvent').length;
                            
                            // Debug: Log all event types to see what we're getting
                            const eventTypes = events.map(event => event.type);
                            const uniqueEventTypes = [...new Set(eventTypes)];
                            
                            
                            
                        } else {
                            
                        }
                    } else {
                        
                    }
                } catch (eventsError) {
                    
                }
                
                // Calculate activity metrics with improved data
                const totalStars = repositories.reduce((sum, repo) => sum + repo.stargazers_count, 0);
                const totalForks = repositories.reduce((sum, repo) => sum + repo.forks_count, 0);
                
                const activityData = {
                    reposContributed: repositories.length,
                    publicRepos: repositories.filter(repo => !repo.private).length,
                    privateRepos: repositories.filter(repo => repo.private).length,
                    totalStars: totalStars,
                    totalForks: totalForks,
                    commits: commits,
                    pullRequests: pullRequests,
                    issues: issues,
                    contributions: events.length,
                    lastActivity: events.length > 0 ? events[0]?.created_at : new Date().toISOString(),
                    languages: getLanguageStats(repositories),
                    topRepos: repositories
                        .sort((a, b) => b.stargazers_count - a.stargazers_count)
                        .slice(0, 5)
                        .map(repo => ({
                            name: repo.name,
                            stars: repo.stargazers_count,
                            forks: repo.forks_count,
                            language: repo.language,
                            url: repo.html_url
                        })),
                    activityFetchedAt: new Date().toISOString()
                };
                
                
                
                // Save activity data to the same Members document
                
                await window.setDoc(window.doc(window.db, 'Members', userId), {
                    githubActivity: activityData,
                    lastActivityUpdate: new Date().toISOString()
                }, { merge: true });
                
                
                
            } catch (error) {
                
                throw error;
            }
        }

        function getLanguageStats(repositories) {
            const languageCount = {};
            repositories.forEach(repo => {
                if (repo.language) {
                    languageCount[repo.language] = (languageCount[repo.language] || 0) + 1;
                }
            });
            
            const languageStats = Object.entries(languageCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([language, count]) => ({ language, count }));
            
            
            return languageStats;
        }

        // GitHub connection is now mandatory - no skip option

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.querySelector('span').textContent = message;
            successDiv.style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('span').textContent = message;
            errorDiv.style.display = 'block';
            
            // Reset button state
            const btn = document.getElementById('githubConnectBtn');
            btn.classList.remove('loading');
            btn.disabled = false;
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
